{
	"$schema": "https://docs.renovatebot.com/renovate-schema.json",
	"extends": [
		"config:recommended"
	],
	"customDatasources": {
		"grafana-dashboards": {
			"defaultRegistryUrlTemplate": "https://grafana.com/api/dashboards/{{packageName}}",
			"format": "json",
			"transformTemplates": [
				"{\"releases\":[{\"version\": $string(revision)}]}"
			]
		}
	},
	"customManagers": [
		{
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"repo\\s*=\\s*\"(?<registryUrl>\\S+)\"\\s*;\\s*name\\s*=\\s*\"(?<depName>\\S+)\"\\s*;\\s*version\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;"
			],
			"datasourceTemplate": "helm",
			"depTypeTemplate": "{{{registryUrl}}}"
		},
		{
			"depTypeTemplate": "helm-oci",
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"repo\\s*=\\s*\"oci:\\/\\/(?<depName>\\S+)\"\\s*;\\s*version\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;"
			],
			"datasourceTemplate": "docker"
		},
		{
			"depTypeTemplate": "docker",
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"imageName\\s*=\\s*\"(?<depName>\\S+)\"\\s*;\\s*finalImageTag\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;\\s*imageDigest\\s*=\\s*\"(?<currentDigest>\\S+)\"\\s*;"
			],
			"datasourceTemplate": "docker"
		},
		{
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"(?<depName>\\S+)\\s*=\\s*{\\s*gnetId\\s*=\\s*(?<packageName>[0-9]+)\\s*;\\s*revision\\s*=\\s*(?<currentValue>[0-9]+)\\s*;"
			],
			"depNameTemplate": "grafana-dashboard-{{depName}}",
			"versioningTemplate": "regex:^(?<major>\\d+)$",
			"datasourceTemplate": "custom.grafana-dashboards"
		}
	],
	"packageRules": [
		{
			"matchDatasources": ["helm"],
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | HOME=/nix sh -s -- --no-daemon --yes",
					"rm *.tgz; HOME=/nix /nonexistent/.nix-profile/bin/nix-shell -p kubernetes-helm --run 'helm pull --repo {{{depType}}} {{{depName}}} --version {{{newVersion}}}'",
					"HOME=/nix /nonexistent/.nix-profile/bin/nix-hash --flat --type sha256 --sri *.tgz | sed 's/\\//\\\\\\//' | tee new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depType}}} {{{replace '/' '\\\\/' depName}}}\\\\)/\\\\1$(cat new-hash)\\\\2/\" {{{packageFile}}}"
				]
			}
		},
		{
			"matchDepTypes": ["helm-oci"],
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | HOME=/nix sh -s -- --no-daemon --yes",
					"rm *.tgz; HOME=/nix /nonexistent/.nix-profile/bin/nix-shell -p kubernetes-helm --run 'helm pull oci://{{{depName}}} --version {{{newVersion}}}'",
					"HOME=/nix /nonexistent/.nix-profile/bin/nix-hash --flat --type sha256 --sri *.tgz | sed 's/\\//\\\\\\//' | tee new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depName}}}\\\\)/\\\\1$(cat new-hash)\\\\2/\" {{{packageFile}}}"
				]
			}
		},
		{
			"matchDepTypes": ["docker"],
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install | HOME=/nix sh -s -- --no-daemon --yes",
					"rm /nix/tmp-image; HOME=/nix /nonexistent/.nix-profile/bin/nix-shell -p skopeo --run 'skopeo --insecure-policy copy docker://{{{depName}}}@{{{newDigest}}} docker-archive:///nix/tmp-image:{{{depName}}}:{{{newValue}}}'",
					"HOME=/nix /nonexistent/.nix-profile/bin/nix-hash --flat --type sha256 --sri /nix/tmp-image | sed 's/\\//\\\\\\//' | tee new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depName}}}\\\\)/\\\\1$(cat new-hash)\\\\2/\" {{{packageFile}}}"
				]
			}
		},
		{
			"matchUpdateTypes": [
				"patch",
				"digest"
			],
			"groupName": "automerge-patch",
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchUpdateTypes": [
				"minor"
			],
			"matchDepNames": [
				"cloudnative-pg",
				"code.forgejo.org/forgejo-helm/forgejo",
				"ghcr.io/woodpecker-ci/helm/woodpecker",
				"ghcr.io/prometheus-community/charts/kube-prometheus-stack",
				"mail",
				"cert-manager",
				"snowdreamtech/frpc",
				"registry.k8s.io/git-sync/git-sync",
				"nginxinc/nginx-unprivileged",
				"px01/blocky",
				"klutchell/unbound"
			],
			"groupName": "automerge-minor",
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchDepNames": [
				"renovate",
				"ghcr.io/jeffvli/feishin",
				"docker.io/searxng/searxng",
				"^grafana-dashboard-"
			],
			"groupName": "automerge-reckless",
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchDepNames": [
				"authelia"
			],
			"groupName": "dont-automerge",
			"automerge": false
		}
	]
}
