{
	"$schema": "https://docs.renovatebot.com/renovate-schema.json",
	"extends": [
		"config:best-practices"
	],
	"customDatasources": {
		"grafana-dashboards": {
			"defaultRegistryUrlTemplate": "https://grafana.com/api/dashboards/{{packageName}}",
			"format": "json",
			"transformTemplates": [
				"{\"releases\":[{\"version\": $string(revision)}]}"
			]
		}
	},
	"customManagers": [
		{
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"repo\\s*=\\s*\"(?<registryUrl>\\S+)\"\\s*;\\s*name\\s*=\\s*\"(?<depName>\\S+)\"\\s*;\\s*version\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;(\\s*# versioning: (?<versioning>\\S+))?"
			],
			"datasourceTemplate": "helm",
			"depTypeTemplate": "{{{registryUrl}}}"
		},
		{
			"depTypeTemplate": "helm-oci",
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"repo\\s*=\\s*\"oci:\\/\\/(?<depName>\\S+)\"\\s*;\\s*version\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;(\\s*# versioning: (?<versioning>\\S+))?"
			],
			"datasourceTemplate": "docker"
		},
		{
			"depTypeTemplate": "docker",
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"imageName\\s*=\\s*\"(?<depName>\\S+)\"\\s*;\\s*finalImageTag\\s*=\\s*\"(?<currentValue>\\S+)\"\\s*;(\\s*# versioning: (?<versioning>\\S+))?\\s*imageDigest\\s*=\\s*\"(?<currentDigest>\\S+)\"\\s*;"
			],
			"datasourceTemplate": "docker"
		},
		{
			"customType": "regex",
			"managerFilePatterns": ["/\\.nix$/"],
			"matchStrings": [
				"(?<depName>\\S+)\\s*=\\s*{\\s*gnetId\\s*=\\s*(?<packageName>[0-9]+)\\s*;\\s*revision\\s*=\\s*(?<currentValue>[0-9]+)\\s*;"
			],
			"depNameTemplate": "grafana-dashboard-{{depName}}",
			"versioningTemplate": "regex:^(?<major>\\d+)$",
			"datasourceTemplate": "custom.grafana-dashboards"
		}
	],
	"packageRules": [
		{
			"matchDatasources": ["helm"],
			"pinDigests": false,
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"rm *.tgz || true",
					"nix-shell -p kubernetes-helm --run 'helm pull --repo {{{depType}}} {{{depName}}} --version {{{newValue}}}'",
					"nix-hash --flat --type sha256 --sri *.tgz | sed 's/\\//\\\\\\//g' > new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depType}}} {{{replace '/' '\\\\/' depName}}}\\\\) {{{currentValue}}}/\\\\1$(cat new-hash)\\\\2 {{{newValue}}}/g\" {{{packageFile}}}",
					"rm config/rke2/helm-images/{{{depName}}}_*.nix || true",
					"nix-shell -p kubernetes-helm yq-go skopeo nix --run \"sh ./utils/helm-mkimages --repo {{{depType}}} {{{depName}}} --version {{{newValue}}} $(grep '# renovate-args: ' {{{packageFile}}} | sed 's/.*# renovate-args: //') > 'config/rke2/helm-images/{{{depName}}}_{{{newValue}}}.nix'\""
				]
			}
		},
		{
			"matchDepTypes": ["helm-oci"],
			"pinDigests": false,
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"rm *.tgz || true",
					"nix-shell -p kubernetes-helm --run 'helm pull oci://{{{depName}}} --version {{{newValue}}}'",
					"nix-hash --flat --type sha256 --sri *.tgz | sed 's/\\//\\\\\\//g' > new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depName}}}\\\\) {{{currentValue}}}/\\\\1$(cat new-hash)\\\\2 {{{newValue}}}/g\" {{{packageFile}}}",
					"rm config/rke2/helm-images/{{{replace '/' '-' depName}}}_*.nix || true",
					"nix-shell -p kubernetes-helm yq-go skopeo nix --run \"sh ./utils/helm-mkimages oci://{{{depName}}} --version {{{newValue}}} $(grep '# renovate-args: ' {{{packageFile}}} | sed 's/.*# renovate-args: //') > 'config/rke2/helm-images/{{{replace '/' '-' depName}}}_{{{newValue}}}.nix'\""
				]
			}
		},
		{
			"matchDepTypes": ["docker"],
			"postUpgradeTasks": {
				"fileFilters": ["**/*.nix"],
				"commands": [
					"rm /nix/tmp-image || true",
					"nix-shell -p skopeo --run 'skopeo --insecure-policy copy docker://{{{depName}}}@{{{newDigest}}} docker-archive:///nix/tmp-image:{{{depName}}}:{{{newValue}}}'",
					"nix-hash --flat --type sha256 --sri /nix/tmp-image | sed 's/\\//\\\\\\//g' > new-hash",
					"sed -i \"s/\\\\(hash = \\\"\\\\)\\\\S*\\\\(\\\"; # renovate: {{{replace '/' '\\\\/' depName}}}\\\\) {{{currentValue}}}/\\\\1$(cat new-hash)\\\\2 {{{newValue}}}/g\" {{{packageFile}}}"
				]
			}
		},
		{
			"matchUpdateTypes": [
				"patch",
				"digest"
			],
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchUpdateTypes": [
				"minor"
			],
			"matchDepNames": [
				"cloudnative-pg",
				"code.forgejo.org/forgejo-helm/forgejo",
				"ghcr.io/woodpecker-ci/helm/woodpecker",
				"ghcr.io/prometheus-community/charts/kube-prometheus-stack",
				"mail",
				"cert-manager",
				"snowdreamtech/frpc",
				"registry.k8s.io/git-sync/git-sync",
				"nginxinc/nginx-unprivileged",
				"px01/blocky",
				"klutchell/unbound",
				"ghcr.io/cloudnative-pg/postgresql",
				"docker.io/envoyproxy/envoy"
			],
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchDepNames": [
				"renovate",
				"ghcr.io/jeffvli/feishin",
				"searxng/searxng",
				"lldap/lldap",
				"^grafana-dashboard-"
			],
			"automerge": true,
			"automergeType": "branch"
		},
		{
			"matchDepNames": [
				"authelia"
			],
			"automerge": false
		},
		{
			"matchUpdateTypes": ["major"],
			"matchDepNames": [
				"ghcr.io/cloudnative-pg/postgresql"
			],
			"enabled": false
		},
		{
			"matchManagers": ["woodpecker"],
			"minimumReleaseAge": "16 days"
		}
	],
	"minimumReleaseAge": "14 days"
}
