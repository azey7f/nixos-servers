#!/usr/bin/env nix-shell
#!nix-shell -i sh -p kubernetes-helm yq-go skopeo
#
# outputs a .nix file that imports all images contained in helm chart
# ./helm-mkimages --repo https://helm.github.io/examples hello-world --version 0.1.0

img_list=$(helm template "$@" | yq -N '..|.image? | select(.)' | sort -u | grep -Px "\\S+:\\S+")

echo -n "\
{pkgs, ...}: {
  # args: $@
  config.services.rke2.images = builtins.map pkgs.dockerTools.pullImage ["

for img in $img_list
do
	nodigest=$(echo $img | cut -d@ -f1)

	name=$(echo $nodigest | cut -d: -f1)
	tag=$(echo $nodigest | cut -d: -f2)

	if [ "$name" = "$nodigest" ]
	then
		digest=$(skopeo inspect docker://$nodigest -f "{{.Digest}}")
	else
		digest=$(echo $img | cut -d@ -f2)
	fi

	skopeo --insecure-policy copy docker://$name@$digest docker-archive:///tmp/helm-mkimages-skopeo:$nodigest >/dev/null
	hash=$(nix-hash --flat --type sha256 --sri /tmp/helm-mkimages-skopeo)
	rm /tmp/helm-mkimages-skopeo; 

	# tag at the end, so the renovate regex doesn't try updating these
	echo -n "
    {
      imageName = \"$name\";
      imageDigest = \"$digest\";
      hash = \"$hash\";
      finalImageTag = \"$tag\";
    }"
done

echo "
  ];
}"
