#!/usr/bin/env sh
#
# outputs an az.server.net.mullvad.serverConfigs definition, see config/networking/mullvad
# only selects mullvad-owned servers

json=$(curl https://api.mullvad.net/www/relays/all/ 2>/dev/null | jq -r '.[] | select(.type == "wireguard" and .owned and .active)')

echo -n "\
# file auto-generated by <nixos-servers>/scripts/mullvad-mkservers on $(date -Iseconds)
# from https://api.mullvad.net/www/relays/all/
{"

for server in $(echo $json | jq -r '.hostname')
do
	v=$(echo $json | jq -r ". | select(.hostname == \"$server\")")

	echo -n "
  \"$server\" = {
    publicKey = \"$(echo $v | jq -r '.pubkey')\";
    ipv4.addr = \"$(echo $v | jq -r '.ipv4_addr_in')\";
    ipv6.addr = \"$(echo $v | jq -r '.ipv6_addr_in')\";
  };"
done

echo "
}"
